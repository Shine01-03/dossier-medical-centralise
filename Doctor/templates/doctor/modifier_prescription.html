{% extends 'doctor/base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5" style="max-width: 1000px;">
  <div class="card shadow-lg">

    <!-- En-t√™te -->
    <div class="card-header text-white d-flex justify-content-between align-items-center" style="background-color: hsl(214, 64%, 35%)">
      <h4 class="mb-0">‚úèÔ∏è Modifier la prescription du {{ prescription.date_prescription|date:"d/m/Y √† H:i" }}</h4>
      <small><i>Par le Dr. {{ prescription.medecin.get_full_name }}</i></small>
    </div>

    <div class="card-body">

      {% if antecedents_critiques %}
        <div class="alert alert-danger fw-bold">
          ‚ö†Ô∏è Ce patient pr√©sente des informations critiques :
          <ul class="mb-0">
            {% for antecedent in antecedents_critiques %}
              <li><strong>{{ antecedent.get_type_antecedent_display }} :</strong> {{ antecedent.description }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      <form method="post" class="row g-4">
        {% csrf_token %}

        <!-- Remarques de la prescription -->
        <div class="col-12">
          <label class="form-label">Remarques</label>
          {{ prescription_form.remarques }}
        </div>

        <!-- Formset m√©dicaments -->
        {{ medicament_formset.management_form }}
        <div id="formset-container">
          {% for form in medicament_formset %}
            <div class="border rounded p-3 mb-3 shadow-sm formset-form">
              <div class="mb-2">
                <label class="form-label">Nom du m√©dicament</label>
                {{ form.nom_medicament }}
              </div>
              <div class="mb-2">
                <label class="form-label">Posologie</label>
                {{ form.posologie }}
              </div>
              <div class="mb-2">
                <label class="form-label">Dur√©e du traitement (en jours)</label>
                {{ form.duree_traitement }}
              </div>
              <div class="form-check">
                {{ form.DELETE }} <label class="form-check-label">Supprimer ce m√©dicament</label>
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- Ajouter un m√©dicament -->
        <div class="text-center mt-2">
          <button type="button" class="btn btn-outline-primary" id="add-form">
            ‚ûï Ajouter un m√©dicament
          </button>
        </div>

        <!-- Boutons -->
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-success btn-lg px-4">
            üíæ Enregistrer les modifications
          </button>
          <a href="{% url 'details_patient' patient.id %}" class="btn btn-outline-secondary btn-lg px-4">
            ‚ùå Annuler
          </a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const addBtn = document.getElementById("add-form");
  const container = document.getElementById("formset-container");
  const totalForms = document.getElementById("id_form-TOTAL_FORMS");

  addBtn.addEventListener("click", () => {
    const formCount = parseInt(totalForms.value);
    const newForm = container.querySelector(".formset-form").cloneNode(true);

    // Vider les champs du nouveau formulaire
    newForm.querySelectorAll("input, textarea").forEach(input => input.value = "");

    // Mettre √† jour les noms et ids pour Django
    newForm.innerHTML = newForm.innerHTML.replaceAll(`form-${formCount-1}`, `form-${formCount}`);

    container.appendChild(newForm);
    totalForms.value = formCount + 1;
  });
</script>
{% endblock %}
